name: Generate posts.json

on:
  push:
    branches:
      - main
    paths:
      - 'posts/**'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Generate posts.json
        run: |
          node -e "
          const fs = require('fs');
          const path = require('path');
          const postsDir = path.join(process.cwd(), 'posts');
          
          if (!fs.existsSync(postsDir)) process.exit(0);
          
          const files = fs.readdirSync(postsDir).filter(f => f.endsWith('.md'));
          const posts = files.map(f => {
            const content = fs.readFileSync(path.join(postsDir, f), 'utf-8');
            const lines = content.split('\n');
            let title = f.replace('.md', '');
            let date = new Date().toISOString().split('T')[0];
            
            if (lines[0] === '---') {
              for (let i = 1; i < lines.length; i++) {
                if (lines[i] === '---' || lines[i] === '--- ') break;
                if (lines[i].startsWith('title:')) {
                  title = lines[i].replace('title:', '').trim().replace(/^['\"]|['\"]$/g, '');
                }
                if (lines[i].startsWith('date:')) {
                  date = lines[i].replace('date:', '').trim().replace(/^['\"]|['\"]$/g, '').split('T')[0];
                }
              }
            } else {
              const h1 = lines.find(l => l.startsWith('# '));
              if (h1) title = h1.replace('# ', '').trim();
            }
            return { id: f.replace('.md', ''), title, date };
          });
          
          posts.sort((a, b) => new Date(b.date) - new Date(a.date));
          fs.writeFileSync('posts.json', JSON.stringify(posts, null, 2));
          "

      - name: Commit posts.json
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add posts.json
          git commit -m "chore: auto-update posts.json [skip ci]" || echo "No changes to commit"
          git push
